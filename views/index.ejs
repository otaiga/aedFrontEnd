<!DOCTYPE html>
<html>
  <head>
    <title>Save A Life - AED Locator Map</title>
    <link rel='stylesheet' href='/css/custom.css'/>
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
    <script src="/js/handlebars.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  </head>
  <body>
    <nav class="light-blue lighten-1" role="navigation">
      <div class="nav-wrapper container">
        <a id="logo-container" href="/" class="brand-logo">AED Locator Map</a>
      </div>
    </nav>
    <div id='map'></div>
    <footer class="page-footer orange">
      <div class="footer-copyright">
        <div class="container">
          Made by <a class="orange-text text-lighten-3" href="https://twitter.com/kdturner?lang=en">Karl Turner</a>
        </div>
      </div>
    </footer>

    <script>
      function createInfoContent(location) {
        const template = document.getElementById('aedTemplate').innerHTML;
        const compiledTemplate = Handlebars.compile(template);
        return compiledTemplate(location);
      }

      function initMap() {
        var infowindow = new google.maps.InfoWindow();
        const map = new google.maps.Map(document.getElementById('map'), {
          zoom: 8,
          minZoom: 5,
          center: new google.maps.LatLng(52.2232, -0.9837),
          mapTypeId: 'terrain',
        });

        const markers = <%- JSON.stringify(aedData) %>.map((location) => {
          const marker = new google.maps.Marker({
            position: { lat: location.latitude, lng: location.longitude },
          });
          marker.addListener('click', () => {
            infowindow.close();
            infowindow.setContent(createInfoContent(location));
            infowindow.open(map, marker);
          });
          return marker;
        });
        new MarkerClusterer(map, markers, { imagePath: '/images/m' });
      }
    </script>
    <script id="aedTemplate" type="text/x-handlebars-template">
      <div id="siteNotice"></div>
      <h5 id="firstHeading" class="firstHeading">{{facility_name}}</h5>
      <div id="bodyContent">
        <p>
          <b>{{address_line_1}}, {{address_line_2}}, {{post_code}}</b>
        </p>
        <ul>
          {{#if phone}}
            <li><b>Phone Contact</b>: {{phone}}</li>
          {{/if}}
          <li><b>Number of AEDs</b>: {{aed_count}}</li>
          {{#if aed_location}}
            <li><b>Location of AED</b>: {{aed_location}}</li>
          {{/if}}
        </ul>
      </div>
    </script>
    <script src='/js/markerClusterer.js'></script>
    <script async defer src='https://maps.googleapis.com/maps/api/js?key=<%- googleKey %>&callback=initMap'></script>
  </body>
</html>
